<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://andrody.github.io/kinbox-lib/kinboxjs.js"></script>
  
  <style>
    body { margin: 0; padding: 10px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: transparent; }

    /* Classe base para bot√µes */
    .btn {
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: center; gap: 8px;
      margin-bottom: 10px;
    }
    .btn:disabled { background-color: #b0c4de; cursor: not-allowed; box-shadow: none; opacity: 0.7; }

    /* Cores Espec√≠ficas */
    .btn-criar { background-color: #2684ff; color: #ffffff; } /* Azul */
    .btn-criar:hover { background-color: #1a6fd8; }

    .btn-negocio { background-color: #28a745; color: #ffffff; } /* Verde Sucesso */
    .btn-negocio:hover { background-color: #218838; }

    .btn-junk { background-color: #dc3545; color: #ffffff; } /* Vermelho Perigo */
    .btn-junk:hover { background-color: #c82333; }

    #status-msg { margin-top: 10px; font-size: 13px; text-align: center; font-weight: 500; min-height: 18px; line-height: 1.4; }
    #status-msg a { text-decoration: underline; font-weight: bold; cursor: pointer; }
    
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .warning { color: #d39e00; } /* Amarelo Escuro para alertas */
    .info { color: #6c757d; font-size: 11px; text-align: center; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div id="info-msg" class="info">Carregando...</div>

  <button id="btn-criar-lead" class="btn btn-criar" onclick="enviarParaN8NParaCriar()" disabled>
    ‚úÖ Criar Lead no Bitrix
  </button>

  <button id="btn-negocio-lead" class="btn btn-negocio" onclick="enviarParaN8NParaNegocio()" disabled>
    üöÄ Converter em Neg√≥cio
  </button>

  <button id="btn-junk-lead" class="btn btn-junk" onclick="enviarParaN8NParaDescartar()" disabled>
    üóëÔ∏è Descartar (Junk)
  </button>
  
  <div id="status-msg"></div>

<script>
  // --- CONFIGURA√á√ÉO ---
  const webhookParaCriar = 'https://webhookrota.aled1.com/webhook/9aaa9ced-dad3-4674-b0a8-b28601ce989a';
  const webhookParaAtualizar = 'https://webhookrota.aled1.com/webhook/e012b659-b9d3-48dd-b8d5-4af9c9cc6275';
  const bitrixBaseUrl = 'https://atacadaoled.bitrix24.com.br/crm/lead/details/'; // URL Base do seu Bitrix
  
  var rawConversationData = null;

  // --- SDK KINBOX ---
  Kinbox.on("conversation", function (data) {
    rawConversationData = data;
    atualizarEstadoBotoes(true, data);
  });

  Kinbox.on("no_conversation", function (data) {
    rawConversationData = null;
    atualizarEstadoBotoes(false, null);
  });

  function atualizarEstadoBotoes(ativo, data) {
    const btnCriar = document.getElementById("btn-criar-lead");
    const btnNegocio = document.getElementById("btn-negocio-lead");
    const btnJunk = document.getElementById("btn-junk-lead");
    const info = document.getElementById("info-msg");
    const msgDiv = document.getElementById("status-msg");

    if (ativo && data && data.contact) {
        btnCriar.disabled = false;
        btnNegocio.disabled = false;
        btnJunk.disabled = false;
        
        btnCriar.innerHTML = "‚úÖ Criar Lead no Bitrix";
        btnNegocio.innerHTML = "üöÄ Converter em Neg√≥cio";
        btnJunk.innerHTML = "üóëÔ∏è Descartar (Junk)";
        info.innerText = "";
        // N√£o limpamos msgDiv aqui para n√£o sumir mensagens importantes de resposta
    } else {
        btnCriar.disabled = true;
        btnNegocio.disabled = true;
        btnJunk.disabled = true;
        info.innerText = "Selecione uma conversa";
    }
  }

  // --- FUN√á√ïES DE DISPARO ---
  async function enviarParaN8NParaCriar() {
    if (!rawConversationData) return;
    executarEnvio('criar');
  }

  async function enviarParaN8NParaNegocio() {
    if (!rawConversationData) return;
    executarEnvio('negocio');
  }

  async function enviarParaN8NParaDescartar() {
    if (!rawConversationData) return;
    executarEnvio('descartar');
  }

  // --- FUN√á√ÉO GEN√âRICA DE ENVIO ---
  async function executarEnvio(acao) {
    const btnCriar = document.getElementById('btn-criar-lead');
    const btnNegocio = document.getElementById('btn-negocio-lead');
    const btnJunk = document.getElementById('btn-junk-lead');
    const msgDiv = document.getElementById('status-msg');

    const urlAlvo = acao === 'criar' ? webhookParaCriar : webhookParaAtualizar;
    
    // Bloqueia
    btnCriar.disabled = true;
    btnNegocio.disabled = true;
    btnJunk.disabled = true;

    msgDiv.innerText = 'Processando...';
    msgDiv.className = '';

    const payload = {
        body: rawConversationData,
        origin: "plugin_sysled_buttons",
        action: acao 
    };

    try {
      const response = await fetch(urlAlvo, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      // Importante: Lemos o JSON da resposta do n8n
      const result = await response.json();

      if (response.ok) {
        if (acao === 'criar') {
            
            // Verifica a flag que configuramos no n8n
            if (result.lead_exists) {
                const linkLead = result.lead_id ? `${bitrixBaseUrl}${result.lead_id}/` : '#';
                msgDiv.innerHTML = `‚ö†Ô∏è Lead j√° existe!<br><a href="${linkLead}" target="_blank" style="color: #d39e00;">Abrir no Bitrix ‚Üó</a>`;
                msgDiv.className = 'warning';
                resetarBotoesComDelay(10000); // 10 segundos para dar tempo de clicar
            } else {
                msgDiv.innerText = '‚úÖ Lead criado com sucesso!';
                msgDiv.className = 'success';
                resetarBotoesComDelay(3000);
            }

        } else if (acao === 'negocio') {
            msgDiv.innerText = 'üöÄ Convertido em Neg√≥cio!';
            msgDiv.className = 'success';
            resetarBotoesComDelay(3000);
        } else {
            msgDiv.innerText = 'üóëÔ∏è Lead marcado como Junk!';
            msgDiv.className = 'error';
            resetarBotoesComDelay(3000);
        }
      } else {
        throw new Error('Erro no servidor');
      }

    } catch (error) {
      console.error(error);
      msgDiv.innerText = '‚ùå Falha na requisi√ß√£o';
      msgDiv.className = 'error';
      resetarBotoesComDelay(3000);
    } 
  }

  function resetarBotoesComDelay(tempo) {
      setTimeout(() => {
        if (rawConversationData) {
            atualizarEstadoBotoes(true, rawConversationData);
            document.getElementById('status-msg').innerText = ''; // Limpa msg
        }
      }, tempo);
  }
</script>

</body>
</html>