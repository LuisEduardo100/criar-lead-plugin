<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://andrody.github.io/kinbox-lib/kinboxjs.js"></script>

  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: transparent;
    }

    /* Classe base para bot√µes */
    .btn {
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn:disabled {
      background-color: #b0c4de;
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
    }

    /* Cores Espec√≠ficas */
    .btn-criar {
      background-color: #2684ff;
      color: #ffffff;
    }

    .btn-criar:hover {
      background-color: #1a6fd8;
    }

    .btn-negocio {
      background-color: #28a745;
      color: #ffffff;
    }

    .btn-negocio:hover {
      background-color: #218838;
    }

    .btn-junk {
      margin-top: 80px;
      background-color: #dc3545;
      color: #ffffff;
    }

    .btn-junk:hover {
      background-color: #c82333;
    }

    #status-msg {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
      font-weight: 500;
      min-height: 18px;
      line-height: 1.4;
    }

    #status-msg a {
      text-decoration: underline;
      font-weight: bold;
      cursor: pointer;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .warning {
      color: #d39e00;
    }

    .info {
      color: #6c757d;
      font-size: 11px;
      text-align: center;
      margin-bottom: 5px;
    }
  </style>
</head>

<body>

  <div id="info-msg" class="info">Carregando...</div>

  <button id="btn-criar-lead" class="btn btn-criar" onclick="enviarParaN8NParaCriar()" disabled>
    ‚úÖ Criar Lead no Bitrix
  </button>

  <button id="btn-negocio-lead" class="btn btn-negocio" onclick="enviarParaN8NParaNegocio()" disabled>
    üöÄ Converter em Neg√≥cio
  </button>

  <button id="btn-junk-lead" class="btn btn-junk" onclick="enviarParaN8NParaDescartar()" disabled>
    üóëÔ∏è Descartar (Junk)
  </button>

  <div id="status-msg"></div>

  <script>
    // --- CONFIGURA√á√ÉO ---
    const webhookParaCriar = 'https://webhookrota.aled1.com/webhook/9aaa9ced-dad3-4674-b0a8-b28601ce989a';
    const webhookParaAtualizar = 'https://webhookrota.aled1.com/webhook/e012b659-b9d3-48dd-b8d5-4af9c9cc6275';
    const bitrixBaseUrl = 'https://atacadaoled.bitrix24.com.br/crm/lead/details/';

    var rawConversationData = null;

    // --- SDK KINBOX ---
    Kinbox.on("conversation", function (data) {
      rawConversationData = data;
      atualizarEstadoBotoes(true, data);
    });

    Kinbox.on("no_conversation", function (data) {
      rawConversationData = null;
      atualizarEstadoBotoes(false, null);
    });

    function atualizarEstadoBotoes(ativo, data) {
      const btnCriar = document.getElementById("btn-criar-lead");
      const btnNegocio = document.getElementById("btn-negocio-lead");
      const btnJunk = document.getElementById("btn-junk-lead");
      const info = document.getElementById("info-msg");

      if (ativo && data && data.contact) {
        btnCriar.disabled = false;
        btnNegocio.disabled = false;
        btnJunk.disabled = false;

        btnCriar.innerHTML = "‚úÖ Criar Lead no Bitrix";
        btnNegocio.innerHTML = "üöÄ Converter em Neg√≥cio";
        btnJunk.innerHTML = "üóëÔ∏è Descartar (Junk)";
        info.innerText = "";
      } else {
        btnCriar.disabled = true;
        btnNegocio.disabled = true;
        btnJunk.disabled = true;
        info.innerText = "Selecione uma conversa";
      }
    }

    // --- FUN√á√ïES DE DISPARO ---
    async function enviarParaN8NParaCriar() {
      if (!rawConversationData) return;
      executarEnvio('criar');
    }

    async function enviarParaN8NParaNegocio() {
      if (!rawConversationData) return;
      executarEnvio('negocio');
    }

    async function enviarParaN8NParaDescartar() {
      if (!rawConversationData) return;
      executarEnvio('descartar');
    }

    var isProcessing = false;

    async function executarEnvio(acao) {
      if (isProcessing) return;
      isProcessing = true;

      const btnCriar = document.getElementById('btn-criar-lead');
      const btnNegocio = document.getElementById('btn-negocio-lead');
      const btnJunk = document.getElementById('btn-junk-lead');
      const msgDiv = document.getElementById('status-msg');
      const delayToEnable = 3500;

      const urlAlvo = acao === 'criar' ? webhookParaCriar : webhookParaAtualizar;

      // UX: Bloqueia e avisa
      btnCriar.disabled = true;
      btnNegocio.disabled = true;
      btnJunk.disabled = true;
      
      msgDiv.innerHTML = '<span style="color:#666">‚è≥ Validando dados no Bitrix...</span>';
      msgDiv.className = '';

      const payload = {
        body: rawConversationData,
        origin: "plugin_sysled_buttons",
        action: acao
      };

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);

        const response = await fetch(urlAlvo, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        const textResponse = await response.text();
        console.log("Resposta N8N:", textResponse);

        let jsonResponse;
        try {
          jsonResponse = JSON.parse(textResponse);
        } catch (e) {
          throw new Error("N8N retornou algo que n√£o √© JSON v√°lido.");
        }

        if (!response.ok) throw new Error("Erro HTTP: " + response.status);

        // ============================================================
        // [NOVO] BLINDAGEM DE CAMPOS FALTANTES E ERROS L√ìGICOS
        // ============================================================
        
        // 1. Verifica se o n8n retornou explicitamente 'res_webhook: false'
        // Isso acontece quando o Switch do n8n identifica campos vazios.
        if (jsonResponse.res_webhook === false) {
            
            let msgErro = '‚ö†Ô∏è <b>Aten√ß√£o - Faltam Dados:</b><br>';
            
            if (jsonResponse.campos_faltantes && Array.isArray(jsonResponse.campos_faltantes) && jsonResponse.campos_faltantes.length > 0) {
                // Formata a lista para ficar leg√≠vel (ex: classificacao_da_obra, valor_total)
                const camposFormatados = jsonResponse.campos_faltantes.join(", ");
                msgErro += `<span style="font-size:12px; color:#d63384;">${camposFormatados}</span>`;
            } else if (jsonResponse.tipo_classificado) {
                // Caso n√£o venha o array, mas venha o tipo do erro
                msgErro += `<span style="font-size:12px">${jsonResponse.tipo_classificado}</span>`;
            } else {
                msgErro += "Verifique os campos obrigat√≥rios no CRM.";
            }

            // Exibe a mensagem amarela (warning) e PARA a execu√ß√£o aqui.
            exibirMensagem(msgErro, 'warning', 6000);
            return; 
        }

        // 2. Valida√ß√£o de erro gen√©rico
        if (jsonResponse.error) {
           throw new Error(jsonResponse.message || "Erro desconhecido no fluxo.");
        }

        // ============================================================
        // FLUXO NORMAL (SUCESSO)
        // ============================================================

        if (acao === 'criar') {
          const idBitrix = jsonResponse.lead_id || jsonResponse.ID || jsonResponse.id;
          const linkLead = idBitrix ? `${bitrixBaseUrl}${idBitrix}/` : '#';

          if (jsonResponse.lead_exists) {
              exibirMensagem(`‚ö†Ô∏è Lead j√° existe.<br><a href="${linkLead}" target="_blank">Abrir no Bitrix ‚Üó</a>`, 'warning', 5000);
          } else {
              exibirMensagem(`‚úÖ Lead Criado: ID ${idBitrix}<br><a href="${linkLead}" target="_blank">Abrir no Bitrix ‚Üó</a>`, 'success', delayToEnable);
          }

        } else if (acao === 'negocio') {
          const idDeal = jsonResponse.deal_id || jsonResponse.dealId || jsonResponse.id;
          const linkDeal = idDeal ? `https://atacadaoled.bitrix24.com.br/crm/deal/details/${idDeal}/` : '#';
          
          if(jsonResponse.already_converted) {
              exibirMensagem(`‚ö†Ô∏è J√° era um neg√≥cio!<br><a href="${linkDeal}" target="_blank">Abrir Neg√≥cio ‚Üó</a>`, 'warning', delayToEnable);
          } else {
              exibirMensagem(`üöÄ Neg√≥cio Criado!<br><a href="${linkDeal}" target="_blank">Abrir Neg√≥cio ‚Üó</a>`, 'success', delayToEnable);
          }

        } else {
          exibirMensagem('üóëÔ∏è Lead enviado para Junk!', 'error', delayToEnable);
        }

      } catch (error) {
        console.error("ERRO:", error);
        if (error.name === 'AbortError') {
            exibirMensagem('‚ö†Ô∏è Demorou muito, verifique o Bitrix manualmente.', 'warning', delayToEnable);
        } else {
            exibirMensagem('‚ùå ' + error.message, 'error', delayToEnable);
        }
      } finally {
        isProcessing = false;
      }
    }

    function exibirMensagem(html, classe, delay) {
      const msgDiv = document.getElementById('status-msg');
      msgDiv.innerHTML = html;
      msgDiv.className = classe;
      resetarBotoesComDelay(delay);
    }

    function resetarBotoesComDelay(tempo) {
      setTimeout(() => {
        if (rawConversationData) {
          atualizarEstadoBotoes(true, rawConversationData);
          document.getElementById('status-msg').innerText = '';
        }
      }, tempo);
    }
  </script>

</body>
</html>