<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://andrody.github.io/kinbox-lib/kinboxjs.js"></script>

  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: transparent;
    }

    /* --- ESTILOS DOS BOT√ïES PRINCIPAIS --- */
    .btn {
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn:disabled {
      background-color: #b0c4de;
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
    }

    .btn-criar {
      background-color: #2684ff;
      color: #ffffff;
    }

    .btn-criar:hover {
      background-color: #1a6fd8;
    }

    .btn-negocio {
      background-color: #28a745;
      color: #ffffff;
    }

    .btn-negocio:hover {
      background-color: #218838;
    }

    .btn-junk {
      margin-top: 80px;
      background-color: #dc3545;
      color: #ffffff;
    }

    .btn-junk:hover {
      background-color: #c82333;
    }

    /* --- ESTILOS DE STATUS --- */
    #status-msg {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
      font-weight: 500;
      min-height: 18px;
      line-height: 1.4;
    }

    #status-msg a {
      text-decoration: underline;
      font-weight: bold;
      cursor: pointer;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .warning {
      color: #d39e00;
    }

    .info {
      color: #6c757d;
      font-size: 11px;
      text-align: center;
      margin-bottom: 5px;
    }

    /* --- ESTILOS DO POPUP (MODAL) --- */
    .modal-overlay {
      display: none;
      /* Escondido por padr√£o */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s;
    }

    .modal-content {
      background-color: #fff;
      padding: 25px 20px;
      border-radius: 12px;
      width: 85%;
      max-width: 320px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      text-align: center;
      animation: slideUp 0.3s;
    }

    .close-x {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      line-height: 1;
    }

    .close-x:hover {
      color: #000;
    }

    .modal-icon {
      font-size: 40px;
      margin-bottom: 10px;
      display: block;
    }

    .modal-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
    }

    .text-success {
      color: #28a745;
    }

    .text-error {
      color: #dc3545;
    }

    .modal-desc {
      font-size: 15px;
      color: #555;
      margin-bottom: 20px;
      display: block;
      font-weight: 500;
    }

    /* Bot√£o de Sucesso (Abrir CRM) */
    .btn-modal-crm {
      display: inline-block;
      background-color: #3bc8f5;
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      border-radius: 30px;
      font-weight: bold;
      font-size: 14px;
      width: 70%;
      transition: background 0.2s, transform 0.1s;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-modal-crm:hover {
      background-color: #0fafdb;
      transform: translateY(-1px);
    }

    /* Bot√£o de Erro (Fechar) */
    .btn-modal-close {
      background-color: #6c757d;
      cursor: pointer;
    }

    .btn-modal-close:hover {
      background-color: #5a6268;
    }

    /* Tags de Erro */
    .erro-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-bottom: 20px;
    }

    .tag-erro {
      background-color: #ffe6e6;
      color: #d63384;
      border: 1px solid #f1aeb5;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    /* Anima√ß√µes */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
      }

      to {
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>

  <div id="info-msg" class="info">Carregando...</div>

  <button id="btn-criar-lead" class="btn btn-criar" onclick="enviarParaN8NParaCriar()" disabled>
    ‚úÖ Criar Lead no Bitrix
  </button>

  <button id="btn-negocio-lead" class="btn btn-negocio" onclick="enviarParaN8NParaNegocio()" disabled>
    üöÄ Converter em Neg√≥cio
  </button>

  <button id="btn-junk-lead" class="btn btn-junk" onclick="enviarParaN8NParaDescartar()" disabled>
    üóëÔ∏è Descartar (Junk)
  </button>

  <div id="status-msg"></div>

  <div id="modal-sucesso" class="modal-overlay" onclick="fecharModalSeClicarFora(event)">
    <div class="modal-content">
      <span class="close-x" onclick="fecharModal()">&times;</span>

      <span id="modal-icon" class="modal-icon">‚úÖ</span>
      <span id="modal-title" class="modal-title text-success">T√≠tulo</span>

      <div id="content-success" style="display:none;">
        <span id="modal-lead-nome" class="modal-desc">Nome do Lead</span>
        <a id="modal-btn-link" href="#" target="_blank" class="btn-modal-crm">
          Abrir no CRM ‚Üó
        </a>
      </div>

      <div id="content-error" style="display:none;">
        <p style="font-size:13px; color:#666; margin:0 0 10px 0;">Os seguintes campos s√£o obrigat√≥rios:</p>
        <div id="lista-erros" class="erro-container">
        </div>
        <button onclick="fecharModal()" class="btn-modal-crm btn-modal-close">
          Entendi, vou corrigir
        </button>
      </div>

    </div>
  </div>

  <script>
    // --- CONFIGURA√á√ÉO ---
    const webhookParaCriar = 'https://webhookrota.aled1.com/webhook/9aaa9ced-dad3-4674-b0a8-b28601ce989a';
    const webhookParaAtualizar = 'https://webhookrota.aled1.com/webhook/e012b659-b9d3-48dd-b8d5-4af9c9cc6275';
    const bitrixBaseUrlLead = 'https://atacadaoled.bitrix24.com.br/crm/lead/details/';
    const bitrixBaseUrlDeal = 'https://atacadaoled.bitrix24.com.br/crm/deal/details/';

    var rawConversationData = null;

    // --- SDK KINBOX ---
    Kinbox.on("conversation", function (data) {
      rawConversationData = data;
      atualizarEstadoBotoes(true, data);
    });

    Kinbox.on("no_conversation", function (data) {
      rawConversationData = null;
      atualizarEstadoBotoes(false, null);
    });

    function atualizarEstadoBotoes(ativo, data) {
      const btnCriar = document.getElementById("btn-criar-lead");
      const btnNegocio = document.getElementById("btn-negocio-lead");
      const btnJunk = document.getElementById("btn-junk-lead");
      const info = document.getElementById("info-msg");

      if (ativo && data && data.contact) {
        btnCriar.disabled = false;
        btnNegocio.disabled = false;
        btnJunk.disabled = false;

        btnCriar.innerHTML = "‚úÖ Criar Lead no Bitrix";
        btnNegocio.innerHTML = "üöÄ Converter em Neg√≥cio";
        btnJunk.innerHTML = "üóëÔ∏è Descartar (Junk)";
        info.innerText = "";
      } else {
        btnCriar.disabled = true;
        btnNegocio.disabled = true;
        btnJunk.disabled = true;
        info.innerText = "Selecione uma conversa";
      }
    }

    // --- FUN√á√ïES DE DISPARO ---
    async function enviarParaN8NParaCriar() { if (!rawConversationData) return; executarEnvio('criar'); }
    async function enviarParaN8NParaNegocio() { if (!rawConversationData) return; executarEnvio('negocio'); }
    async function enviarParaN8NParaDescartar() { if (!rawConversationData) return; executarEnvio('descartar'); }

    // --- L√ìGICA DO POPUP (MODAL) ---

    // MODO SUCESSO
    function abrirModalSucesso(titulo, icone, nome, link) {
      // Configura textos
      document.getElementById('modal-title').innerText = titulo;
      document.getElementById('modal-title').className = "modal-title text-success";
      document.getElementById('modal-icon').innerText = icone;
      document.getElementById('modal-lead-nome').innerText = nome;
      document.getElementById('modal-btn-link').href = link;

      // Alterna visibilidade
      document.getElementById('content-success').style.display = 'block';
      document.getElementById('content-error').style.display = 'none';

      // Abre
      document.getElementById('modal-sucesso').style.display = 'flex';
    }

    // MODO ERRO (Dados Faltantes)
    function abrirModalErro(listaCampos) {
      // Configura textos
      document.getElementById('modal-title').innerText = "Dados Faltantes!";
      document.getElementById('modal-title').className = "modal-title text-error";
      document.getElementById('modal-icon').innerText = "‚ö†Ô∏è";

      // Gera as tags
      const container = document.getElementById('lista-erros');
      container.innerHTML = ""; // Limpa anterior

      if (listaCampos && listaCampos.length > 0) {
        listaCampos.forEach(campo => {
          const tag = document.createElement("span");
          tag.className = "tag-erro";
          // Remove underline e deixa mai√∫scula primeira letra (ex: nome_do_cliente -> Nome do cliente)
          const textoFormatado = campo.replace(/_/g, " ").replace(/^\w/, c => c.toUpperCase());
          tag.innerText = textoFormatado;
          container.appendChild(tag);
        });
      } else {
        container.innerHTML = "<span class='tag-erro'>Campos Obrigat√≥rios</span>";
      }

      // Alterna visibilidade
      document.getElementById('content-success').style.display = 'none';
      document.getElementById('content-error').style.display = 'block';

      // Abre
      document.getElementById('modal-sucesso').style.display = 'flex';
    }

    function fecharModal() {
      document.getElementById('modal-sucesso').style.display = 'none';
      document.getElementById('status-msg').innerText = '';
    }

    function fecharModalSeClicarFora(event) {
      if (event.target.id === 'modal-sucesso') { fecharModal(); }
    }

    var isProcessing = false;

    async function executarEnvio(acao) {
      if (isProcessing) return;
      isProcessing = true;

      const btnCriar = document.getElementById('btn-criar-lead');
      const btnNegocio = document.getElementById('btn-negocio-lead');
      const btnJunk = document.getElementById('btn-junk-lead');
      const msgDiv = document.getElementById('status-msg');

      const urlAlvo = acao === 'criar' ? webhookParaCriar : webhookParaAtualizar;

      // UX: Bloqueia e avisa
      btnCriar.disabled = true;
      btnNegocio.disabled = true;
      btnJunk.disabled = true;

      msgDiv.innerHTML = '<span style="color:#666">‚è≥ Processando...</span>';
      msgDiv.className = '';

      const payload = {
        body: rawConversationData,
        origin: "plugin_sysled_buttons",
        action: acao
      };

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000);

        const response = await fetch(urlAlvo, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        const textResponse = await response.text();
        let jsonResponse;
        try {
          jsonResponse = JSON.parse(textResponse);
        } catch (e) {
          throw new Error("Resposta inv√°lida do servidor.");
        }

        if (!response.ok) throw new Error("Erro HTTP: " + response.status);

        // =======================================================
        // TRATAMENTO DE ERROS / DADOS FALTANTES (MODAL)
        // =======================================================
        if (jsonResponse.res_webhook === false) {
          // Se vier lista de campos faltantes, mostra o modal de erro
          if (jsonResponse.campos_faltantes && Array.isArray(jsonResponse.campos_faltantes) && jsonResponse.campos_faltantes.length > 0) {
            abrirModalErro(jsonResponse.campos_faltantes);
          }
          // Se for outro tipo de erro classificado
          else if (jsonResponse.tipo_classificado) {
            exibirMensagem(`‚ö†Ô∏è ${jsonResponse.tipo_classificado}`, 'warning', 6000);
          } else {
            exibirMensagem("‚ö†Ô∏è Verifique os campos obrigat√≥rios.", 'warning', 6000);
          }
          return; // Para a execu√ß√£o
        }

        if (jsonResponse.error) throw new Error(jsonResponse.message || "Erro desconhecido.");

        // =======================================================
        // SUCESSO (MODAL VERDE / FOGUETE)
        // =======================================================

        if (acao === 'criar') {
          const idBitrix = jsonResponse.lead_id || jsonResponse.ID;
          const linkLead = jsonResponse.lead_link ? jsonResponse.lead_link : `${bitrixBaseUrlLead}${idBitrix}/`;

          if (jsonResponse.lead_exists) {
            if (jsonResponse.lead_exists) {
              // ALTERA√á√ÉO: Agora chamamos o Modal mesmo se j√° existir, mas mudamos o √≠cone e t√≠tulo
              abrirModalSucesso(
                "Lead J√° Existe!",      // T√≠tulo
                "‚ö†Ô∏è",                   // √çcone de alerta (ou use ‚úÖ se preferir)
                jsonResponse.lead_name || "Cliente", // Nome do cliente
                linkLead                // Link gerado para o bot√£o
              );
              // Mensagem r√°pida no rodap√© apenas para refor√ßar
              exibirMensagem('‚ö†Ô∏è Lead j√° cadastrado.', 'warning', 100);
            } else {
              // L√≥gica original para novos leads...
              abrirModalSucesso("Lead Criado!", "‚úÖ", jsonResponse.lead_name || "Cliente", linkLead);
              exibirMensagem('‚úÖ Sucesso!', 'success', 100);
            }
          } else {
            abrirModalSucesso("Lead Criado!", "‚úÖ", jsonResponse.lead_name || "Cliente", linkLead);
            exibirMensagem('‚úÖ Sucesso!', 'success', 100);
          }

        } else if (acao === 'negocio') {
          const idDeal = jsonResponse.deal_id || jsonResponse.dealId || jsonResponse.id;
          const linkDeal = jsonResponse.deal_link ? jsonResponse.deal_link : `${bitrixBaseUrlDeal}${idDeal}/`;
          const nomeNegocio = jsonResponse.deal_title || "Neg√≥cio Convertido";

          if (jsonResponse.already_converted) {
            exibirMensagem(`‚ö†Ô∏è J√° era Neg√≥cio!<br><a href="${linkDeal}" target="_blank">Abrir Neg√≥cio ‚Üó</a>`, 'warning', 4000);
          } else {
            abrirModalSucesso("Neg√≥cio Criado!", "üöÄ", nomeNegocio, linkDeal);
            exibirMensagem('üöÄ Sucesso!', 'success', 100);
          }

        } else {
          // 2. Se deu certo (res_webhook: true), prepara os dados para o Modal
          // Tenta pegar o ID do lead da resposta para montar o link
          const idBitrix = jsonResponse.lead_id || jsonResponse.ID;
          // Se n√£o vier link pronto, monta com a URL base
          const linkLead = jsonResponse.lead_link ? jsonResponse.lead_link : (idBitrix ? `${bitrixBaseUrlLead}${idBitrix}/` : '#');
          const nomeLead = jsonResponse.lead_name || "Lead";

          // 3. Abre o Modal de Sucesso
          abrirModalSucesso("Lead Descartado!", "üóëÔ∏è", nomeLead, linkLead);

          // TRUQUE VISUAL: Troca a cor do t√≠tulo para Vermelho (padr√£o de erro/alerta) para diferenciar do sucesso verde
          const modalTitle = document.getElementById('modal-title');
          modalTitle.className = "modal-title text-error"; // Usa a classe vermelha do CSS existente

          // Exibe mensagem r√°pida no rodap√© tamb√©m
          exibirMensagem('üóëÔ∏è Lead enviado para Junk!', 'error', 100);
        }

      } catch (error) {
        console.error("ERRO:", error);
        const msg = error.name === 'AbortError' ? '‚ö†Ô∏è Demorou muito, verifique o Bitrix.' : '‚ùå ' + error.message;
        exibirMensagem(msg, 'warning', 4000);
      } finally {
        isProcessing = false;
      }
    }

    function exibirMensagem(html, classe, delay) {
      const msgDiv = document.getElementById('status-msg');
      msgDiv.innerHTML = html;
      msgDiv.className = classe;
      resetarBotoesComDelay(delay);
    }

    function resetarBotoesComDelay(tempo) {
      setTimeout(() => {
        if (rawConversationData) {
          atualizarEstadoBotoes(true, rawConversationData);
          if (document.getElementById('modal-sucesso').style.display !== 'flex') {
            document.getElementById('status-msg').innerText = '';
          }
        }
      }, tempo);
    }
  </script>

</body>

</html>