<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://andrody.github.io/kinbox-lib/kinboxjs.js"></script>

  <style>
    body {
      margin: 0;
      padding: 10px;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: transparent;
    }

    /* Classe base para bot√µes */
    .btn {
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .btn:disabled {
      background-color: #b0c4de;
      cursor: not-allowed;
      box-shadow: none;
      opacity: 0.7;
    }

    /* Cores Espec√≠ficas */
    .btn-criar {
      background-color: #2684ff;
      color: #ffffff;
    }

    /* Azul */
    .btn-criar:hover {
      background-color: #1a6fd8;
    }

    .btn-negocio {
      background-color: #28a745;
      color: #ffffff;
    }

    /* Verde Sucesso */
    .btn-negocio:hover {
      background-color: #218838;
    }

    .btn-junk {
      background-color: #dc3545;
      color: #ffffff;
    }

    /* Vermelho Perigo */
    .btn-junk:hover {
      background-color: #c82333;
    }

    #status-msg {
      margin-top: 10px;
      font-size: 13px;
      text-align: center;
      font-weight: 500;
      min-height: 18px;
      line-height: 1.4;
    }

    #status-msg a {
      text-decoration: underline;
      font-weight: bold;
      cursor: pointer;
    }

    .success {
      color: #28a745;
    }

    .error {
      color: #dc3545;
    }

    .warning {
      color: #d39e00;
    }

    /* Amarelo Escuro para alertas */
    .info {
      color: #6c757d;
      font-size: 11px;
      text-align: center;
      margin-bottom: 5px;
    }
  </style>
</head>

<body>

  <div id="info-msg" class="info">Carregando...</div>

  <button id="btn-criar-lead" class="btn btn-criar" onclick="enviarParaN8NParaCriar()" disabled>
    ‚úÖ Criar Lead no Bitrix
  </button>

  <button id="btn-negocio-lead" class="btn btn-negocio" onclick="enviarParaN8NParaNegocio()" disabled>
    üöÄ Converter em Neg√≥cio
  </button>

  <button id="btn-junk-lead" class="btn btn-junk" onclick="enviarParaN8NParaDescartar()" disabled>
    üóëÔ∏è Descartar (Junk)
  </button>

  <div id="status-msg"></div>

  <script>
    // --- CONFIGURA√á√ÉO ---
    const webhookParaCriar = 'https://webhookrota.aled1.com/webhook/9aaa9ced-dad3-4674-b0a8-b28601ce989a';
    const webhookParaAtualizar = 'https://webhookrota.aled1.com/webhook/e012b659-b9d3-48dd-b8d5-4af9c9cc6275'; // Usado para Converter/Descartar
    const bitrixBaseUrl = 'https://atacadaoled.bitrix24.com.br/crm/lead/details/';

    var rawConversationData = null;

    // --- SDK KINBOX ---
    Kinbox.on("conversation", function (data) {
      rawConversationData = data;
      atualizarEstadoBotoes(true, data);
    });

    Kinbox.on("no_conversation", function (data) {
      rawConversationData = null;
      atualizarEstadoBotoes(false, null);
    });

    function atualizarEstadoBotoes(ativo, data) {
      const btnCriar = document.getElementById("btn-criar-lead");
      const btnNegocio = document.getElementById("btn-negocio-lead");
      const btnJunk = document.getElementById("btn-junk-lead");
      const info = document.getElementById("info-msg");

      if (ativo && data && data.contact) {
        btnCriar.disabled = false;
        btnNegocio.disabled = false;
        btnJunk.disabled = false;

        btnCriar.innerHTML = "‚úÖ Criar Lead no Bitrix";
        btnNegocio.innerHTML = "üöÄ Converter em Neg√≥cio";
        btnJunk.innerHTML = "üóëÔ∏è Descartar (Junk)";
        info.innerText = "";
      } else {
        btnCriar.disabled = true;
        btnNegocio.disabled = true;
        btnJunk.disabled = true;
        info.innerText = "Selecione uma conversa";
      }
    }

    // --- FUN√á√ïES DE DISPARO ---
    async function enviarParaN8NParaCriar() {
      if (!rawConversationData) return;
      executarEnvio('criar');
    }

    async function enviarParaN8NParaNegocio() {
      if (!rawConversationData) return;
      executarEnvio('negocio');
    }

    async function enviarParaN8NParaDescartar() {
      if (!rawConversationData) return;
      executarEnvio('descartar');
    }

    // --- FUN√á√ÉO GEN√âRICA DE ENVIO ---
    async function executarEnvio(acao) {
      const btnCriar = document.getElementById('btn-criar-lead');
      const btnNegocio = document.getElementById('btn-negocio-lead');
      const btnJunk = document.getElementById('btn-junk-lead');
      const msgDiv = document.getElementById('status-msg');
      const delayToEnable = 3500

      // Define qual webhook chamar
      const urlAlvo = acao === 'criar' ? webhookParaCriar : webhookParaAtualizar;

      // Bloqueia bot√µes
      btnCriar.disabled = true;
      btnNegocio.disabled = true;
      btnJunk.disabled = true;

      msgDiv.innerText = 'Processando...';
      msgDiv.className = '';

      const payload = {
        body: rawConversationData,
        origin: "plugin_sysled_buttons",
        action: acao
      };

      try {
        const response = await fetch(urlAlvo, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const textResponse = await response.text();
        console.log("Resposta N8N:", textResponse);

        if (!textResponse) throw new Error("Resposta vazia do n8n.");

        let jsonResponse;
        try {
          jsonResponse = JSON.parse(textResponse);
        } catch (e) {
          throw new Error("Resposta n√£o √© JSON v√°lido.");
        }

        if (!response.ok) throw new Error("Erro HTTP: " + response.status);

        // --- L√ìGICA DE RESPOSTA ---

        // 1. Erro de Valida√ß√£o (Campos Faltando)
        if (jsonResponse.res_webhook === false) {
          let msgErro = '‚ö†Ô∏è <b>Faltam dados:</b>';
          if (jsonResponse.campos_faltantes && jsonResponse.campos_faltantes.length > 0) {
            msgErro += `<br><span style="font-size:11px">${jsonResponse.campos_faltantes.join(", ")}</span>`;
          } else if (jsonResponse.tipo_classificado === "tip_orc_vazio") {
            msgErro += `<br><span style="font-size:11px">Preencha o Tipo de Or√ßamento</span>`;
          }
          exibirMensagem(msgErro, 'warning', 5000);
          return;
        }

        // 2. L√≥gica para CRIA√á√ÉO/ATUALIZA√á√ÉO DE LEAD
        if (acao === 'criar') {
          const linkLead = jsonResponse.lead_id ? `${bitrixBaseUrl}${jsonResponse.lead_id}/` : '#';

          if (jsonResponse.lead_exists) {
            if (jsonResponse.was_updated) {
              // CASO 1: Lead existia mas foi VINCULADO com sucesso (Verde)
              exibirMensagem(`üîÑ Lead Atualizado e Vinculado!<br><a href="${linkLead}" target="_blank">Abrir no Bitrix ‚Üó</a>`, 'success', delayToEnable);
            } else {
              // CASO 2: Lead existe e n√£o precisou mudar nada (Amarelo)
              exibirMensagem(`‚ö†Ô∏è Lead j√° cadastrado.<br><a href="${linkLead}" target="_blank">Abrir no Bitrix ‚Üó</a>`, 'warning', 5000);
            }
          } else {
            // CASO 3: Lead Novo Criado (Verde)
            exibirMensagem(`‚úÖ Lead Criado: ID ${jsonResponse.lead_id}<br><a href="${linkLead}" target="_blank">Abrir no Bitrix ‚Üó</a>`, 'success', delayToEnable);
          }

          // 3. L√≥gica para NEG√ìCIO
        } else if (acao === 'negocio') {
          const linkDeal = jsonResponse.deal_id ? `https://atacadaoled.bitrix24.com.br/crm/deal/details/${jsonResponse.deal_id}/` : '#';
          exibirMensagem(`üöÄ Neg√≥cio Criado!<br><a href="${linkDeal}" target="_blank">Abrir Neg√≥cio ‚Üó</a>`, 'success', delayToEnable);

          // 4. L√≥gica para JUNK
        } else {
          exibirMensagem('üóëÔ∏è Lead enviado para Junk!', 'error', delayToEnable);
        }

      } catch (error) {
        console.error("ERRO:", error);
        exibirMensagem('‚ùå Erro: ' + error.message, 'error', delayToEnable);
      }
    }

    function exibirMensagem(html, classe, delay) {
      const msgDiv = document.getElementById('status-msg');
      msgDiv.innerHTML = html;
      msgDiv.className = classe;
      resetarBotoesComDelay(delay);
    }

    function resetarBotoesComDelay(tempo) {
      setTimeout(() => {
        if (rawConversationData) {
          atualizarEstadoBotoes(true, rawConversationData);
          document.getElementById('status-msg').innerText = '';
        }
      }, tempo);
    }
  </script>

</body>

</html>