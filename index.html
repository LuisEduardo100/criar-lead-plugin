<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript" src="https://andrody.github.io/kinbox-lib/kinboxjs.js"></script>
  
  <style>
    body { margin: 0; padding: 10px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: transparent; }

    /* Estilo do bot√£o Criar (Azul Sysled) */
    .btn-sysled {
      background-color: #2684ff;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: center; gap: 8px;
      margin-bottom: 10px; /* Espa√ßo entre os bot√µes */
    }
    .btn-sysled:hover { background-color: #1a6fd8; }
    .btn-sysled:disabled { background-color: #b0c4de; cursor: not-allowed; box-shadow: none; }

    /* Estilo do bot√£o Descartar (Vermelho/Junk) */
    .btn-junk {
      background-color: #dc3545; /* Vermelho Perigo */
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: background-color 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-junk:hover { background-color: #c82333; }
    .btn-junk:disabled { background-color: #e2aeb3; cursor: not-allowed; box-shadow: none; }

    #status-msg { margin-top: 10px; font-size: 12px; text-align: center; font-weight: 500; min-height: 18px;}
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #6c757d; font-size: 11px; text-align: center; margin-bottom: 5px; }
  </style>
</head>
<body>

  <div id="info-msg" class="info">Carregando...</div>

  <button id="btn-criar-lead" class="btn-sysled" onclick="enviarParaN8NParaCriar()" disabled>
    ‚úÖ Criar Lead no Bitrix
  </button>

  <button id="btn-junk-lead" class="btn-junk" onclick="enviarParaN8NParaDescartar()" disabled>
    üóëÔ∏è Descartar (Junk)
  </button>
  
  <div id="status-msg"></div>

<script>
  // --- CONFIGURA√á√ÉO ---
  const webhookParaCriar = 'https://webhookrota.aled1.com/webhook/9aaa9ced-dad3-4674-b0a8-b28601ce989a';
  const webhookParaDescartar = 'https://webhookrota.aled1.com/webhook/e012b659-b9d3-48dd-b8d5-4af9c9cc6275';
  
  var rawConversationData = null;

  // --- SDK KINBOX ---
  Kinbox.on("conversation", function (data) {
    console.log("Dados Kinbox Recebidos:", data);
    rawConversationData = data;
    
    // Elementos da tela
    const btnCriar = document.getElementById("btn-criar-lead");
    const btnJunk = document.getElementById("btn-junk-lead");
    const info = document.getElementById("info-msg");
    const msgDiv = document.getElementById("status-msg");

    if (data && data.contact) {
        // Habilita ambos os bot√µes
        btnCriar.disabled = false;
        btnJunk.disabled = false;
        
        // Reseta textos
        btnCriar.innerHTML = "‚úÖ Criar Lead no Bitrix";
        btnJunk.innerHTML = "üóëÔ∏è Descartar (Junk)";
        info.innerText = "";
        msgDiv.innerText = "";
    }
  });

  Kinbox.on("no_conversation", function (data) {
    rawConversationData = null;
    document.getElementById("btn-criar-lead").disabled = true;
    document.getElementById("btn-junk-lead").disabled = true;
    document.getElementById("info-msg").innerText = "Selecione uma conversa";
  });

  // --- FUN√á√ÉO 1: CRIAR LEAD ---
  async function enviarParaN8NParaCriar() {
    if (!rawConversationData) return;
    executarEnvio('criar');
  }

  // --- FUN√á√ÉO 2: DESCARTAR LEAD ---
  async function enviarParaN8NParaDescartar() {
    if (!rawConversationData) return;
    executarEnvio('descartar');
  }

  // --- FUN√á√ÉO GEN√âRICA DE ENVIO (Para evitar repeti√ß√£o de c√≥digo) ---
  async function executarEnvio(acao) {
    const btnCriar = document.getElementById('btn-criar-lead');
    const btnJunk = document.getElementById('btn-junk-lead');
    const msgDiv = document.getElementById('status-msg');

    // Define qual webhook e qual bot√£o est√° sendo "focado"
    const urlAlvo = acao === 'criar' ? webhookParaCriar : webhookParaDescartar;
    
    // Bloqueia AMBOS durante o processamento
    btnCriar.disabled = true;
    btnJunk.disabled = true;
    msgDiv.innerText = 'Processando...';
    msgDiv.className = '';

    const payload = {
        body: rawConversationData,
        origin: "plugin_sysled_buttons",
        action: acao // 'criar' ou 'descartar' - √∫til para debug no n8n
    };

    try {
      const response = await fetch(urlAlvo, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.ok) {
        if (acao === 'criar') {
            msgDiv.innerText = '‚úÖ Lead criado com sucesso!';
            msgDiv.className = 'success';
        } else {
            msgDiv.innerText = 'üóëÔ∏è Lead marcado como Junk!';
            msgDiv.className = 'error'; // Usa a cor vermelha para feedback visual de descarte
        }
      } else {
        throw new Error('Erro no servidor');
      }

    } catch (error) {
      console.error(error);
      msgDiv.innerText = '‚ùå Falha na requisi√ß√£o';
      msgDiv.className = 'error';
    } finally {
      // Reabilita os bot√µes ap√≥s 3 segundos
      setTimeout(() => {
        // S√≥ reabilita se ainda tiver conversa selecionada
        if (rawConversationData) {
            btnCriar.disabled = false;
            btnJunk.disabled = false;
            btnCriar.innerHTML = '‚úÖ Criar Lead no Bitrix';
            btnJunk.innerHTML = 'üóëÔ∏è Descartar (Junk)';
            msgDiv.innerText = '';
        }
      }, 3000);
    }
  }
</script>

</body>
</html>